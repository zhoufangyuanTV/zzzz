# 稳定匹配问题
给出男性集合 A 和女性集合 B。  
每位男性心目中存在一个关于女性的优先顺序。  
同理，每位女性心目中也存在一个关于男性的优先顺序。  
## 匹配
就是将男女配对。  
每位男性最多出现在一个配对中。  
同理，每位女性也最多出现在一个配对中。
## 完美匹配
每位男性和女性都在某个配对中。
## 稳定匹配
不存在以下情况的匹配：
- 匹配中有 $(a,b)$ 和 $(c,d)$ 两个配对。
- 在 a 心目中，d 要优于 b。
- 在 d 心目中，a 要优于 c。

如果匹配中出现这种情况，则这不是稳定匹配，并称 $(a,d)$ 为一对不稳定因子。
## Gale-Shapley 算法
算法简介（详细版本自己上网搜）：
1. 每位还没有匹配的男性按自己心中的优先顺序向女性求婚。
2. 如果被求婚的女性原来的匹配不如现在的，则接受求婚，并让原来的和她匹配的男性失配。

显然，对于一位女性，如果她在某一步已经匹配了，那么接下来她只会匹配更优的男性，而不会失配。
### 时间复杂度
$O(n^2)$
### 完美性
证明（反证法）：
- 假设：存在男性 z 在算法终止后仍然未匹配到女性。
- 由此可知，一定有一位女性，假设为 a，也没有匹配到男性。
- 根据算法，一位单身女性一定会同意向她求婚的男性，且女性一旦有配偶就不会再次单身，所以女性 a 一定没有被求过婚。
- 根据算法 while 循环条件，男性 z 一定向所有女性求过婚算法才会终止。
- 因此男性 z 向女性 a 求过婚。
- 矛盾产生，假设不成立，证明完毕。
### 稳定性
证明：
- 假设：匹配中不包含匹配 $(z,a)$。
- 情况1：z 从未向 a 求婚。
- z 比起 a 更喜欢算法得到的配偶 b。
- a-z 不是不稳定因子。
- 情况2：z 向 a 求过婚。
- a 拒绝了或抛弃了 z。
- a 比起 z，更喜欢算法得到的配偶 y。
- a-z 不是不稳定因子。

因此匹配中没有不稳定因子。

根据此算法，可以发现完美稳定匹配是必然存在的。
# 回到本题
## 具体做法
自己看原题题解。

需要注意的是，实现时，应当把不能染色的配对和已经染色的配对的优先度调为最低。  
下面的证明中，若某点（称其为 $(x,y)$）的优先度高于当前点（当前点可以被染色且尚未被染色），就意味着 $(x,y)$ 该点同样可以被染为该种颜色且尚未染色。
## 证明
考虑构造有向图 A，图中的每个点对应一个网格。  
对于每一行，$val_{i,j}$大的点向小的点连边。  
对于每一列，$val_{i,j}$小的点向大的点连边。

显然，每个点有 $n-1$ 条入边，$n-1$ 条出边。  
对于每个点，入边另一端的点在横轴或纵轴上的优先级比他高，出边则反之。

假如现在正在考虑颜色 i，如果 $(x,y)$ 可以染颜色 i，并且它在这一轮中仍然不会被染色，那么他至少有一个尚未染色的入边另一端的点在这一轮被染色。

考虑反证法，若 x 行匹配了一个优先度低的列，且 y 列也匹配了一个优先度低的行，则 $(x,y)$ 是不稳定因子，与稳定匹配矛盾。  
因此行或列必然有一个会选择一个优先度高于 $(x,y)$ 的配对，即染色一个在 $(x,y)$ 的入边上的点。

由于入边只有 $n-1$ 条，因此对于每个点，如果在它可以被染色的前 $n-1$ 轮都没有染色，那么在第 n 轮，它的所有入边上的点都已经染色了，因此它必然会被染色。